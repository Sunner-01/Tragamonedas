/**
 * SISTEMA DE AUDIO (Web Audio API)
 */
class SoundManager {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.enabled = true;
    }

    toggle() {
        this.enabled = !this.enabled;
        const btn = document.getElementById('btn-sound');
        const btnDesktop = document.getElementById('btn-sound-desktop');
        if (btn) btn.textContent = this.enabled ? 'üîä' : 'üîá';
        if (btnDesktop) btnDesktop.textContent = this.enabled ? 'üîä' : 'üîá';
    }

    playTone(freq, type, duration, vol = 0.1) {
        if (!this.enabled) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    spinSound() {
        if (!this.enabled) return;
        const count = 3;
        for (let i = 0; i < count; i++) {
            setTimeout(() => this.playTone(100 + Math.random() * 50, 'square', 0.05, 0.05), i * 80);
        }
    }

    reelStop() { this.playTone(200, 'sine', 0.1, 0.2); }
    winSmall() { this.playTone(400, 'triangle', 0.1); setTimeout(() => this.playTone(600, 'triangle', 0.2), 100); }
    winBig() {
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.linearRampToValueAtTime(800, now + 0.5);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.linearRampToValueAtTime(0, now + 1.5);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(now + 1.5);
    }
}

const audio = new SoundManager();

/**
 * CONFIGURACI√ìN DE S√çMBOLOS (SVG) - DISE√ëOS MEJORADOS
 */
const SYMBOLS = {
    // Cerezas - Gradiente rojo brillante
    0: { id: 0, name: 'Cherry', value: 5, svg: '<svg viewBox="0 0 100 100"><defs><radialGradient id="cherry1"><stop offset="0%" stop-color="#ff4444"/><stop offset="60%" stop-color="#cc0000"/><stop offset="100%" stop-color="#880000"/></radialGradient><radialGradient id="cherry2"><stop offset="0%" stop-color="#ff3333"/><stop offset="60%" stop-color="#bb0000"/><stop offset="100%" stop-color="#770000"/></radialGradient><linearGradient id="stem" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#8B4513"/><stop offset="100%" stop-color="#654321"/></linearGradient></defs><path d="M50 15 Q 40 20 35 35 Q 30 50 32 62" stroke="url(#stem)" stroke-width="3" fill="none"/><path d="M50 15 Q 60 22 68 38 Q 73 53 72 65" stroke="url(#stem)" stroke-width="3" fill="none"/><ellipse cx="32" cy="70" rx="16" ry="17" fill="url(#cherry1)"/><ellipse cx="28" cy="66" rx="5" ry="6" fill="#ff6666" opacity="0.6"/><ellipse cx="72" cy="73" rx="16" ry="17" fill="url(#cherry2)"/><ellipse cx="68" cy="69" rx="5" ry="6" fill="#ff5555" opacity="0.6"/><path d="M50 10 Q 55 5 65 8 Q 70 10 72 15" stroke="#228B22" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M60 7 Q 62 6 66 8" stroke="#32CD32" stroke-width="1.5" fill="none" opacity="0.8"/></svg>' },
    
    // Campana dorada con brillo
    1: { id: 1, name: 'Bell', value: 10, svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="bellGold" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD700"/><stop offset="40%" stop-color="#FFA500"/><stop offset="70%" stop-color="#FFD700"/><stop offset="100%" stop-color="#B8860B"/></linearGradient><radialGradient id="bellShine"><stop offset="0%" stop-color="#FFFF99" opacity="0.9"/><stop offset="100%" stop-color="#FFD700" opacity="0"/></radialGradient></defs><path d="M 30 60 Q 25 25 50 10 Q 75 25 70 60 L 75 75 L 25 75 Z" fill="url(#bellGold)" stroke="#8B6914" stroke-width="2"/><ellipse cx="45" cy="35" rx="12" ry="20" fill="url(#bellShine)"/><rect x="23" y="75" width="54" height="8" rx="2" fill="#B8860B"/><circle cx="50" cy="87" r="7" fill="#8B4513"/><circle cx="50" cy="87" r="4" fill="#654321"/></svg>' },
    
    // Lingote BAR plateado brillante
    2: { id: 2, name: 'Bar', value: 20, svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="silver" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#E8E8E8"/><stop offset="40%" stop-color="#C0C0C0"/><stop offset="70%" stop-color="#F5F5F5"/><stop offset="100%" stop-color="#A8A8A8"/></linearGradient></defs><rect x="12" y="32" width="76" height="36" rx="6" fill="url(#silver)" stroke="#666" stroke-width="2"/><rect x="16" y="36" width="68" height="4" rx="1" fill="#fff" opacity="0.4"/><text x="50" y="58" font-family="Impact" font-weight="900" font-size="22" text-anchor="middle" fill="#333" stroke="#000" stroke-width="0.5">BAR</text></svg>' },
    
    // Doble BAR dorado
    3: { id: 3, name: 'Bar2', value: 40, svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="doubleGold" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD700"/><stop offset="50%" stop-color="#FFA500"/><stop offset="100%" stop-color="#FF8C00"/></linearGradient></defs><rect x="15" y="20" width="70" height="24" rx="4" fill="url(#doubleGold)" stroke="#B8860B" stroke-width="2.5"/><rect x="18" y="23" width="64" height="3" rx="1" fill="#FFFF99" opacity="0.5"/><text x="50" y="38" font-family="Impact" font-weight="900" font-size="16" text-anchor="middle" fill="#8B4513">BAR</text><rect x="15" y="56" width="70" height="24" rx="4" fill="url(#doubleGold)" stroke="#B8860B" stroke-width="2.5"/><rect x="18" y="59" width="64" height="3" rx="1" fill="#FFFF99" opacity="0.5"/><text x="50" y="74" font-family="Impact" font-weight="900" font-size="16" text-anchor="middle" fill="#8B4513">BAR</text></svg>' },
    
    // Triple BAR rojo brillante
    4: { id: 4, name: 'Bar3', value: 60, svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="redBar" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF4444"/><stop offset="50%" stop-color="#DD0000"/><stop offset="100%" stop-color="#990000"/></linearGradient></defs><rect x="12" y="12" width="76" height="20" rx="3" fill="url(#redBar)" stroke="#660000" stroke-width="2"/><rect x="15" y="14" width="70" height="3" rx="1" fill="#FF6666" opacity="0.6"/><rect x="12" y="40" width="76" height="20" rx="3" fill="url(#redBar)" stroke="#660000" stroke-width="2"/><rect x="15" y="42" width="70" height="3" rx="1" fill="#FF6666" opacity="0.6"/><rect x="12" y="68" width="76" height="20" rx="3" fill="url(#redBar)" stroke="#660000" stroke-width="2"/><rect x="15" y="70" width="70" height="3" rx="1" fill="#FF6666" opacity="0.6"/></svg>' },
    
    // Siete con efecto 3D
    5: { id: 5, name: 'Seven', value: 100, svg: '<svg viewBox="0 0 100 100"><defs><linear Gradient id="sevenGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF0000"/><stop offset="30%" stop-color="#FF4444"/><stop offset="60%" stop-color="#CC0000"/><stop offset="100%" stop-color="#990000"/></linearGradient><filter id="shadow7"><feGaussianBlur in="SourceAlpha" stdDeviation="3"/><feOffset dx="3" dy="3" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.5"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><text x="50" y="80" font-family="Impact" font-weight="900" font-size="75" text-anchor="middle" fill="url(#sevenGrad)" stroke="#FFD700" stroke-width="3" filter="url(#shadow7)">7</text><text x="50" y="80" font-family="Impact" font-weight="900" font-size="75" text-anchor="middle" fill="none" stroke="#FFFFFF" stroke-width="1.5" opacity="0.4">7</text></svg>' },
    
    // Diamante cristalino brillante
    6: { id: 6, name: 'Diamond', value: 200, svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="diam1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00FFFF"/><stop offset="50%" stop-color="#0099FF"/><stop offset="100%" stop-color="#0066CC"/></linearGradient><radialGradient id="diamShine"><stop offset="0%" stop-color="#FFFFFF" opacity="0.9"/><stop offset="100%" stop-color="#00FFFF" opacity="0"/></radialGradient></defs><path d="M 25 35 L 50 5 L 75 35 L 50 95 Z" fill="url(#diam1)" stroke="#003366" stroke-width="2"/><path d="M 25 35 L 75 35" stroke="#66CCFF" stroke-width="1.5"/><path d="M 50 5 L 50 35" stroke="#AAFFFF" stroke-width="1"/><path d="M 25 35 L 50 50 L 75 35" stroke="#FFFFFF" stroke-width="1" opacity="0.6"/><ellipse cx="50" cy="25" rx="15" ry="12" fill="url(#diamShine)"/><path d="M 35 30 L 50 35 L 65 30" stroke="#FFFFFF" stroke-width="2" opacity="0.7"/></svg>' },
    
    // Estrella WILD dorada brillante
    7: { id: 7, name: 'Wild', value: 500, type: 'wild', svg: '<svg viewBox="0 0 100 100"><defs><radialGradient id="starGold"><stop offset="0%" stop-color="#FFFF00"/><stop offset="40%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FFA500"/></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><polygon points="50,8 59,38 91,38 65,57 74,87 50,68 26,87 35,57 9,38 41,38" fill="url(#starGold)" stroke="#FF4500" stroke-width="3" filter="url(#glow)"/><polygon points="50,15 56,35 75,35 60,47 65,67 50,56 35,67 40,47 25,35 44,35" fill="#FFFF99" opacity="0.5"/><text x="50" y="58" font-family="Impact" font-size="16" font-weight="900" text-anchor="middle" fill="#8B4513" stroke="#000" stroke-width="0.5">WILD</text></svg>' },
    
    // Saco de dinero BONUS
    8: { id: 8, name: 'Scatter', value: 100, type: 'scatter', svg: '<svg viewBox="0 0 100 100"><defs><linearGradient id="bagBrown" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#D2691E"/><stop offset="50%" stop-color="#A0522D"/><stop offset="100%" stop-color="#8B4513"/></linearGradient><linearGradient id="rope" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#F4A460"/><stop offset="100%" stop-color="#CD853F"/></linearGradient></defs><ellipse cx="50" cy="75" rx="32" ry="20" fill="url(#bagBrown)" stroke="#654321" stroke-width="2"/><path d="M 20 55 Q 20 25 50 20 Q 80 25 80 55 L 75 75 Q 75 80 50 85 Q 25 80 25 75 Z" fill="url(#bagBrown)" stroke="#654321" stroke-width="2.5"/><path d="M 35 22 Q 35 18 50 17 Q 65 18 65 22" fill="none" stroke="#654321" stroke-width="2"/><ellipse cx="50" cy="20" rx="15" ry="4" fill="url(#rope)" stroke="#8B4513" stroke-width="1.5"/><path d="M 35 20 L 32 28 Q 30 32 35 33" fill="none" stroke="url(#rope)" stroke-width="3" stroke-linecap="round"/><path d="M 65 20 L 68 28 Q 70 32 65 33" fill="none" stroke="url(#rope)" stroke-width="3" stroke-linecap="round"/><text x="50" y="55" font-family="Impact" font-size="28" font-weight="900" text-anchor="middle" fill="#FFD700" stroke="#654321" stroke-width="1">$</text><circle cx="35" cy="65" r="3" fill="#FFD700" opacity="0.7"/><circle cx="65" cy="68" r="2.5" fill="#FFD700" opacity="0.7"/><circle cx="50" cy="72" r="2" fill="#FFD700" opacity="0.6"/></svg>' }
};

const SYMBOL_KEYS = Object.keys(SYMBOLS).map(Number);
const WEIGHTS = [0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6, 7, 8];

/**
 * L√ìGICA DEL JUEGO (adaptada a 3 carretes)
 */
class SlotMachine {
    constructor() {
        this.username = "JUGADOR";
        this.balance = 1000;
        this.totalBet = 5;
        this.isSpinning = false;
        this.autoSpinActive = false;
        this.reels = [];
        this.grid = [];

        this.paylines = [
            [[0, 0], [1, 0], [2, 0]],
            [[0, 1], [1, 1], [2, 1]],
            [[0, 2], [1, 2], [2, 2]],
            [[0, 0], [1, 1], [2, 2]],
            [[0, 2], [1, 1], [2, 0]]
        ];

        this.init();
    }

    init() {
        this.createReels();
        this.updateUI();
        const jackpot = (Math.random() * 5000 + 10000).toFixed(2);
        document.getElementById('jackpot-amount').innerText = jackpot;
        document.getElementById('jackpot-amount-mobile').innerText = jackpot;
    }

    createReels() {
        const container = document.getElementById('reels-container');
        container.innerHTML = '';
        this.reels = [];

        for (let i = 0; i < 3; i++) {
            const reelDiv = document.createElement('div');
            reelDiv.className = 'reel';

            const strip = document.createElement('div');
            strip.className = 'reel-strip';

            let initialSymbols = [];
            for (let j = 0; j < 6; j++) {
                initialSymbols.push(this.getRandomSymbolId());
            }
            this.renderStrip(strip, initialSymbols);
            
            strip.style.transform = `translateY(-33.33%)`;

            reelDiv.appendChild(strip);
            container.appendChild(reelDiv);

            this.reels.push({
                element: strip,
                symbols: initialSymbols,
                offsetPercent: -33.33
            });
        }
    }

    getRandomSymbolId() {
        const idx = Math.floor(Math.random() * WEIGHTS.length);
        return WEIGHTS[idx];
    }

    renderStrip(element, symbolIds) {
        element.innerHTML = '';
        symbolIds.forEach(id => {
            const div = document.createElement('div');
            div.className = 'symbol';
            div.innerHTML = SYMBOLS[id].svg;
            element.appendChild(div);
        });
    }

    handleManualBet(event) {
        if (this.isSpinning) return;
        let value = parseFloat(event.target.value);
        if (isNaN(value) || value < 1) return;
        
        this.totalBet = Math.round(value * 100) / 100;
        
        [5, 10, 25, 50].forEach(n => {
            const btn = document.getElementById(`btn-bet-${n}`);
            if (btn) btn.classList.remove('active-bet');
        });
        
        this.updateUI();
    }

    adjustBetTotal(amount) {
        if (this.isSpinning) return;
        this.totalBet = amount;
        [5, 10, 25, 50].forEach(n => {
            const btn = document.getElementById(`btn-bet-${n}`);
            if (btn) btn.classList.remove('active-bet');
        });
        const activeBtn = document.getElementById(`btn-bet-${amount}`);
        if (activeBtn) activeBtn.classList.add('active-bet');
        
        document.getElementById('manual-bet-input').value = '';
        
        this.updateUI();
    }

    maxBet() { this.adjustBetTotal(50); }

    toggleAutoSpin() {
        this.autoSpinActive = !this.autoSpinActive;
        const btn = document.getElementById('btn-auto');
        btn.style.background = this.autoSpinActive ? '#ffd700' : '';
        btn.style.color = this.autoSpinActive ? '#000' : '';
        btn.innerText = this.autoSpinActive ? 'STOP' : 'AUTO';
        if (this.autoSpinActive && !this.isSpinning) this.spin();
    }

    updateUI() {
        const balanceStr = this.balance.toFixed(2);
        const betStr = this.totalBet.toFixed(2);
        
        document.getElementById('username-display').innerText = this.username;
        document.getElementById('balance-display').innerText = balanceStr;
        document.getElementById('username-display-mobile').innerText = this.username;
        document.getElementById('balance-display-mobile').innerText = balanceStr;
        document.getElementById('total-bet-display').innerText = betStr;
        document.getElementById('btn-spin').disabled = this.isSpinning || this.balance < this.totalBet;
    }

    clearOverlays() {
        document.getElementById('paylines-svg').innerHTML = '';
        document.querySelectorAll('.symbol').forEach(el => el.classList.remove('win-anim'));
        document.getElementById('message-overlay').style.display = 'none';
        document.getElementById('win-display').innerText = "0.00";
    }

    spin() {
        if (this.isSpinning || this.balance < this.totalBet) {
            if (this.balance < this.totalBet) alert("Saldo insuficiente.");
            return;
        }

        this.isSpinning = true;
        this.balance -= this.totalBet;
        this.clearOverlays();
        this.updateUI();

        this.grid = [];
        for (let col = 0; col < 3; col++) {
            let column = [];
            for (let row = 0; row < 3; row++) column.push(this.getRandomSymbolId());
            this.grid.push(column);
        }

        let completedReels = 0;

        this.reels.forEach((reel, index) => {
            const speed = 5 + index * 0.5;
            const stopDelay = 800 + (index * 400);

            const loop = () => {
                if (!reel.stopping) {
                    reel.offsetPercent += speed;
                    if (reel.offsetPercent >= 0) reel.offsetPercent = -200;
                    reel.element.style.transform = `translateY(${reel.offsetPercent}%)`;
                    if (Math.random() > 0.8) audio.spinSound();
                    reel.animId = requestAnimationFrame(loop);
                } else {
                    const finalSymbols = [
                        this.getRandomSymbolId(),
                        this.grid[index][0],
                        this.grid[index][1],
                        this.grid[index][2],
                        this.getRandomSymbolId(),
                        this.getRandomSymbolId()
                    ];
                    this.renderStrip(reel.element, finalSymbols);
                    reel.element.style.transition = 'transform 0.4s cubic-bezier(0.2, 1.5, 0.5, 1)';
                    reel.element.style.transform = `translateY(-33.33%)`;
                    audio.reelStop();

                    setTimeout(() => {
                        completedReels++;
                        if (completedReels === 3) {
                            this.isSpinning = false;
                            this.evaluateWin();
                        }
                    }, 400);
                }
            };

            reel.stopping = false;
            reel.animId = requestAnimationFrame(loop);

            setTimeout(() => {
                cancelAnimationFrame(reel.animId);
                reel.stopping = true;
                loop();
            }, stopDelay);
        });
    }

    drawPayline(coords, color) {
        const svg = document.getElementById('paylines-svg');
        const container = document.querySelector('.reels-container');
        const gameArea = document.querySelector('.game-area');
        
        // Obtener el padding y border del game-area usando getComputedStyle
        const gameAreaStyle = window.getComputedStyle(gameArea);
        const paddingTop = parseFloat(gameAreaStyle.paddingTop);
        const paddingLeft = parseFloat(gameAreaStyle.paddingLeft);
        const borderTop = parseFloat(gameAreaStyle.borderTopWidth);
        const borderLeft = parseFloat(gameAreaStyle.borderLeftWidth);
        
        // Dimensiones de cada carrete y s√≠mbolo
        const reelWidth = container.offsetWidth / 3;
        const symbolHeight = container.offsetHeight / 3;
        
        let points = "";
        coords.forEach(p => {
            // Calcular posici√≥n considerando padding + border del game-area
            const x = paddingLeft + borderLeft + (p[0] * reelWidth) + (reelWidth / 2);
            const y = paddingTop + borderTop + (p[1] * symbolHeight) + (symbolHeight / 2);
            points += `${x},${y} `;
        });
        
        const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        line.setAttribute("points", points.trim());
        line.setAttribute("fill", "none");
        line.setAttribute("stroke", color);
        line.setAttribute("stroke-width", "5");
        line.setAttribute("stroke-linecap", "round");
        line.style.filter = "drop-shadow(0 0 5px " + color + ")";
        svg.appendChild(line);
    }

    evaluateWin() {
        let totalWin = 0;

        let scatterCount = 0;
        this.grid.flat().forEach(id => { if (SYMBOLS[id].type === 'scatter') scatterCount++; });
        if (scatterCount >= 3) {
            totalWin += this.totalBet * (scatterCount === 3 ? 5 : 10);
            this.highlightSymbolType(8);
        }

        this.paylines.forEach((line, idx) => {
            const ids = line.map(p => this.grid[p[0]][p[1]]);
            const first = ids[0];
            let sym = SYMBOLS[first];
            let count = 1;

            for (let i = 1; i < 3; i++) {
                const s = SYMBOLS[ids[i]];
                if (ids[i] === first || s.type === 'wild') count++;
                else break;
            }

            if (count === 3) {
                const val = sym.type === 'wild' ? 500 : sym.value;
                totalWin += val * (this.totalBet / 5);
                this.drawPayline(line, ['#ff0033', '#00f3ff', '#ffd700'][idx % 3]);

                line.forEach(p => {
                    const dom = this.reels[p[0]].element.children[p[1] + 1];
                    if (dom) dom.classList.add('win-anim');
                });
            }
        });

        if (totalWin > 0) {
            this.balance += totalWin;
            document.getElementById('win-display').innerText = totalWin.toFixed(2);
            totalWin > this.totalBet * 10 ? audio.winBig() : audio.winSmall();
            this.showWinMessage(totalWin);
        } else if (this.autoSpinActive) {
            setTimeout(() => this.spin(), 1200);
        }

        this.updateUI();
    }

    highlightSymbolType(id) {
        this.reels.forEach((reel, c) => {
            this.grid[c].forEach((symId, r) => {
                if (symId === id) reel.element.children[r + 1].classList.add('win-anim');
            });
        });
    }

    showWinMessage(amount) {
        const overlay = document.getElementById('message-overlay');
        const text = document.getElementById('overlay-text');
        const val = document.getElementById('overlay-amount');
        overlay.style.display = 'block';
        val.innerText = "Bs " +amount.toFixed(2);

        if (amount >= this.totalBet * 20) text.innerText = "¬°MEGA PREMIO!";
        else if (amount >= this.totalBet * 10) text.innerText = "¬°GRAN PREMIO!";
        else text.innerText = "¬°GANADOR!";

        setTimeout(() => {
            overlay.style.display = 'none';
            if (this.autoSpinActive && this.balance >= this.totalBet) this.spin();
        }, 2000);
    }
}

const game = new SlotMachine();